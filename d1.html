<!DOCTYPE html>
<html>
<head>
  <title>Jim's Image Generator</title>
</head>
<body style='background:#fff;'>

<h1>AI backdrop generator</h1>
<div style='display:none;'>
  <label>Models</label>
  <select id="modelopts">
    <option value="https://api-inference.huggingface.co/models/digiplay/DreamShaper_7" selected>DreamShaper</option>
    <option value="https://api-inference.huggingface.co/models/emilianJR/XXMix_9realistic">XXMix_9realistic</option>
  </select>
</div>

<textarea id="imageq" style="width:100%; height:50px;" placeholder='Type something to generate the background'></textarea>

<div>
  <label for="resolution">Resolution (width x height):</label>
  <input type="text" id="resolution" placeholder="e.g., 1920x1080">
</div>

<div>
  <label for="scaling">Scaling (between 0.1 to 2):</label>
  <input type="number" id="scaling" step="0.1" min="0.1" max="2" value="1">
</div>

<button onclick="genimg_process()">Generate Image</button>
<a id='dlbtn' style='text-decoration:none;'><button>Download Image</button></a>	
	
<div id="my-div" style="width:100%;">
  <div id="loader" style="display: none;">Loading...</div>
  <img style="width:100%;" onerror="imageLoadFailed()">
  <div id="error-msg" style="display: none;">Image loading failed. Please try again.</div>
</div>
</body>
</html>

<script>
document.body.oncontextmenu = function(event) {
  event.preventDefault();
  return false;
};

async function query(data) {
  let defaultmodel = document.querySelector('#modelopts').value;    
  const response = await fetch(
    defaultmodel,
    {
      headers: { Authorization: "Bearer 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" },
      method: "POST",
      body: JSON.stringify(data),
    }
  );
  const result = await response.blob();
  return result;
}

function showLoader() {
  document.getElementById('loader').style.display = 'block';
}

function hideLoader() {
  document.getElementById('loader').style.display = 'none';
}

function showErrorMessage() {
  document.getElementById('error-msg').style.display = 'block';
}

function hideErrorMessage() {
  document.getElementById('error-msg').style.display = 'none';
}

async function genimg_process() {
  speak("Initiating Artwork Sequence, Please wait");
  var q = document.querySelector('#imageq').value;
  var resolution = document.querySelector('#resolution').value.trim();
  var scaling = parseFloat(document.querySelector('#scaling').value);
  
  if (!resolution.match(/^\d+x\d+$/)) {
    alert("Invalid resolution format. Please use width x height format (e.g., 1920x1080).");
    return;
  }

  if (scaling < 0.1 || scaling > 2) {
    alert("Scaling value should be between 0.1 and 2.");
    return;
  }

  var defpromp = `masterpiece, best quality, (${resolution}), `;
  hideErrorMessage();
  showLoader();
  try {
    const response = await query({
      "inputs": defpromp + q,
      "parameters": {
        "negative_prompt": 'blurry',
        "scaling_factor": scaling,
      }
    });
    convertBlobToBase64(response);
  } catch (error) {
    console.error(error);
    showErrorMessage();
  } finally {
    hideLoader();
  }
}

function convertBlobToBase64(blob) {
  const reader = new FileReader();
  reader.onloadend = () => {
    const base64String = reader.result;
    console.log(base64String);

    const image = document.querySelector('img');
    image.src = base64String + "";
    const anchor = document.querySelector('#dlbtn');
    anchor.href = base64String + "";
    anchor.download = "c137-image.png";
  };
  reader.readAsDataURL(blob);
}

function speak(text, callback) {
  var u = new SpeechSynthesisUtterance();
  u.text = text;
  u.lang = 'en-UK';

  u.onend = function () {
    if (callback) {
      callback();
    }
  };

  u.onerror = function (e) {
    if (callback) {
      callback(e);
    }
  };

  speechSynthesis.speak(u);
}

async function text_query(data) {
  const response = await fetch(
    "https://api-inference.huggingface.co/models/dorkai/pygmalion-2.7b",
    {
      headers: { Authorization: "Bearer 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" },
      method: "POST",
      body: JSON.stringify(data),
    }
  );
  const result = await response.json();
  return result;
}

async function llm_process() {
  speak("Let's make Art Epic");
}

function imageLoadFailed() {
  hideLoader();
  showErrorMessage();
}
</script>
